<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BMW M Speedometer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div id="bmw-speedo" class="m-mode">

  <canvas id="rpmCanvas" width="260" height="260"></canvas>

  <div id="speed-box">
    <div id="speed">0</div>
    <div id="unit">MPH</div>
  </div>

  <div id="gear">N</div>

  <div id="bars">
    <div class="bar">
      <div class="bar-fill fuel" id="fuel-bar"></div>
    </div>
    <div class="bar">
      <div class="bar-fill engine" id="engine-bar"></div>
    </div>
  </div>

</div>

<script src="script.js"></script>

<script>
/* ===== RPM BMW M ===== */
const canvas = document.getElementById("rpmCanvas");
const ctx = canvas.getContext("2d");
let rpmSmooth = 0;

function drawRPM(target = 0) {
  rpmSmooth += (target - rpmSmooth) * 0.18;

  ctx.clearRect(0,0,260,260);
  ctx.lineWidth = 12;

  const redline = rpmSmooth > 0.8;
  ctx.strokeStyle = redline ? "#ff2a2a" : "#ff5555";
  ctx.shadowBlur = redline ? 30 : 15;
  ctx.shadowColor = ctx.strokeStyle;

  ctx.beginPath();
  ctx.arc(130,130,110,Math.PI,Math.PI + Math.PI * rpmSmooth);
  ctx.stroke();
}

/* ===== SAFE OVERRIDES ===== */
const _setRPM = window.setRPM;
window.setRPM = (rpm) => {
  drawRPM(rpm);
  _setRPM(rpm);
};

const _setSpeed = window.setSpeed;
window.setSpeed = (spd) => {
  document.getElementById("speed").innerText = Math.round(spd * 2.23694);
  _setSpeed(spd);
};

const _setGear = window.setGear;
window.setGear = (g) => {
  const el = document.getElementById("gear");
  el.innerText = g;
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"),180);
  _setGear(g);
};

const _setFuel = window.setFuel;
window.setFuel = (f) => {
  document.getElementById("fuel-bar").style.width = (f*100)+"%";
  _setFuel(f);
};

const _setHealth = window.setHealth;
window.setHealth = (h) => {
  document.getElementById("engine-bar").style.width = (h*100)+"%";
  _setHealth(h);
};

setSpeedMode(1); // LOCK MPH
</script>

</body>
</html>
