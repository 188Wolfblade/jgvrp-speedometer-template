<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BMW M Track Speedometer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div id="bmw-speedo" class="m-track">

  <!-- RPM ANALOG -->
  <canvas id="rpmCanvas" width="220" height="220"></canvas>

  <!-- RPM NUMERIC -->
  <div id="rpm-num">0 RPM</div>

  <!-- SPEED -->
  <div id="speed-box">
    <div id="speed">0</div>
    <div id="unit">MPH</div>
  </div>

  <!-- GEAR -->
  <div id="gear">N</div>

  <!-- BARS -->
  <div id="bars">
    <div class="bar-wrap">
      <span class="icon">â›½</span>
      <div class="bar"><div class="bar-fill fuel" id="fuel-bar"></div></div>
    </div>
    <div class="bar-wrap">
      <span class="icon">ðŸ”§</span>
      <div class="bar"><div class="bar-fill engine" id="engine-bar"></div></div>
    </div>
  </div>

  <!-- ODOMETER -->
  <div id="odo">ODO 0.0 mi</div>

</div>

<script src="script.js"></script>

<script>
/* ===== RPM ===== */
const canvas = document.getElementById("rpmCanvas");
const ctx = canvas.getContext("2d");
let rpmSmooth = 0;

function drawRPM(target = 0) {
  rpmSmooth += (target - rpmSmooth) * 0.18;

  ctx.clearRect(0,0,220,220);
  ctx.lineWidth = 9;

  const red = rpmSmooth > 0.8;
  ctx.strokeStyle = red ? "#ff2a2a" : "#ff5555";
  ctx.shadowBlur = red ? 22 : 10;
  ctx.shadowColor = ctx.strokeStyle;

  ctx.beginPath();
  ctx.arc(110,110,95,Math.PI,Math.PI + Math.PI * rpmSmooth);
  ctx.stroke();

  document.getElementById("rpm-num").innerText =
    Math.round(rpmSmooth * 8000) + " RPM";
}

/* ===== SAFE OVERRIDES ===== */
const _setRPM = window.setRPM;
window.setRPM = (rpm) => { drawRPM(rpm); _setRPM(rpm); };

const _setSpeed = window.setSpeed;
window.setSpeed = (s) => {
  document.getElementById("speed").innerText = Math.round(s * 2.23694);
  _setSpeed(s);
};

const _setGear = window.setGear;
window.setGear = (g) => {
  const el = document.getElementById("gear");
  el.innerText = g;
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"),150);
  _setGear(g);
};

const _setFuel = window.setFuel;
window.setFuel = (f) => {
  document.getElementById("fuel-bar").style.width = (f*100)+"%";
  _setFuel(f);
};

const _setHealth = window.setHealth;
window.setHealth = (h) => {
  document.getElementById("engine-bar").style.width = (h*100)+"%";
  _setHealth(h);
};

const _setOdo = window.setOdometer;
window.setOdometer = (d) => {
  document.getElementById("odo").innerText = "ODO " + d.toFixed(1) + " mi";
  _setOdo(d);
};

setSpeedMode(1); // MPH LOCK
</script>

</body>
</html>
